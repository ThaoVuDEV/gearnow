name: Deploy to VPS (self-hosted)

on:
  push:
    branches: [ main ]

defaults:
  run:
    shell: bash -l {0}  # quan trọng: nạp ~/.bashrc => có nvm

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Sync & Build
        run: |
          set -e
          cd /var/www/gearnow

          git config --global --add safe.directory /var/www/gearnow
          git fetch --all
          git reset --hard origin/main
          git clean -fd

          nvm use 22 || nvm install 22     # dùng Node 22
          echo "Node: $(node -v) | NPM: $(npm -v) | which: $(which node)"

          npm run build
